@model CRM.Models.ViewModels.ScheduleListViewModel
@using CRM.Services
@inject ScheduleService ScheduleService
@{
    ViewData["Title"] = "SCHEDULES";
}
<div class="row mb-4">
    <div class="col">
        <div class="card">
            <div class="card-header text-center">
                UNCOMPLETED SCHEDULES
            </div>
            @if (Model.UnCompletedSchedules.Count() > 0)
            {
                <div class="card-body p-0">
                    <table class="table table-borderless table-striped">
                        <thead>
                            <tr>
                                <th>Started at</th>
                                <th>Finished at</th>
                                <th>User</th>
                                <th>Personel</th>
                                <th>Programme</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.UnCompletedSchedules)
                            {
                                <tr class="@if (item.StartedAt < DateTime.Now) { @Html.Raw("table-danger") }  schedule-@item.ID">
                                    <td class="align-middle">@item.StartedAt.ToLongDateString() (@item.StartedAt.ToShortTimeString())</td>
                                    <td class="align-middle">@item.FinishedAt.ToLongDateString() (@item.FinishedAt.ToShortTimeString())</td>
                                    <td class="align-middle">@item.User.FullName()</td>
                                    <td class="align-middle">@item.Personnel.FullName()</td>
                                    <td class="align-middle">
                                        <span class="badge" style="background: @item.Programme.Color">@item.Programme.Name</span>
                                    </td>
                                    <td class="text-right align-middle">
                                        <a href="javascript:;" id="@item.ID" class="btn btn-sm btn-outline-primary">
                                            <span class="fa fa-check"></span>
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
 
                </div>
            }
            else
            {
                <div class="card-body">
                    <div class="alert alert-primary" role="alert">
                        There are no any resources to show here.
                    </div>
                </div>
            }
            <div class="card-footer text-center">
                Total Schedule(s): @Model.UnCompletedSchedules.Count()
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header text-center">
                @ViewData["Title"]
            </div>

            <div class="card-body text-center">
                <div id="calendar"></div>
            </div>
            <div class="card-footer text-center">
                Total Today's Schedule(s): @ScheduleService.DailyScheduleCounts(Model.Member.TeamID)
            </div>
        </div>
    </div>
</div>

@section Styles {
    <partial name="_StylesPartial" />
    <link href='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.9.0/fullcalendar.min.css' rel='stylesheet' />
    <style>
        .list-group-item {
            background: transparent;
        }
    </style>
}

@section Scripts {
    <script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.9.0/fullcalendar.min.js'></script>
    <script>
        $(document).ready(function () {
            $('#calendar').fullCalendar({
                header: {
                    left: 'prev,next',
                    center: '',
                    right: 'month,agendaWeek,agendaDay'
                },
                buttonText: {
                    month: 'Month',
                    agendaDay: 'Day',
                    agendaWeek: 'Week',
                    today: 'Today'
                },
                defaultView: 'agendaWeek',
                editable: false,
                firstDay: 1,
                allDaySlot: false,
                events: 'api/schedules',
                contentHeight: 350,
            });

            var $leftButtons = $('.fc-left .fc-button-group button').removeClass();
            var $rightButtons = $('.fc-right .fc-button-group button').removeClass();

            $leftButtons.addClass('btn btn-primary');
            $rightButtons.addClass('btn btn-primary');
        });
    </script>

    <script>
        $('.btn').click(function () {
            var id = $(this).attr('id');
            $.ajax({
                url: '/api/schedules/' + id,
                type: 'PUT',
                cache: false,
                dataType: 'text',
                contentType: 'application/json; charset=utf-8',
                success: function (data) {
                    $('.schedule-' + id).hide();
                },
                error: function (data) {
                    alert("An error occurred.");
                }
            });
            return false;            
        });
    </script>
}
